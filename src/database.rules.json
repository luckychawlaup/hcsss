
{
  "rules": {
    ".read": false,
    ".write": false,
    "variables": {
      "principalUID": "IIDjN5e6RzUMFGOYJ4kE7t3YqgZ2",
      "ownerUID": "qEB6D6PbjycGSBKMPv9OGyorgnd2"
    },
    "isAdmin": "auth != null && (auth.uid === root.child('variables/principalUID').val() || auth.uid === root.child('variables/ownerUID').val())",
    "isTeacher": "auth != null && root.child('teachers').child(auth.uid).exists()",
    
    "students": {
      ".read": "root.child('isAdmin').val() || root.child('isTeacher').val()",
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "(auth != null && auth.uid === $uid && newData.exists() && !data.exists()) || root.child('isAdmin').val() || (root.child('isTeacher').val() && root.child('teachers').child(auth.uid).child('classTeacherOf').val() === data.child('class').val() + '-' + data.child('section').val())"
      }
    },
    "student_registrations": {
      ".read": "auth != null",
      "$key": {
        ".write": "root.child('isAdmin').val() || (!data.exists() && newData.exists()) || (!newData.exists())"
      }
    },
    "teachers": {
      ".read": "root.child('isAdmin').val() || root.child('isTeacher').val()",
      "$uid": {
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid"
      }
    },
     "registrations": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": "email"
    },
    "announcements": {
      ".read": "auth != null",
      ".write": "root.child('isAdmin').val() || root.child('isTeacher').val()",
      "$announcementId": {
        ".write": "(root.child('isAdmin').val() || root.child('isTeacher').val()) && (!data.exists() || data.child('createdBy').val() === auth.uid)"
      }
    },
    "leaves": {
      ".read": "auth != null",
      ".indexOn": ["userId", "appliedAt", "teacherId"],
      "$leaveId": {
        ".write": "auth != null && ((newData.child('userId').val() === auth.uid && !data.exists()) || root.child('isAdmin').val() || (root.child('isTeacher').val() && auth.uid === newData.child('teacherId').val()))",
        "startDate": { ".write": "auth != null" },
        "endDate": { ".write": "auth != null" },
        "status": {
           ".write": "auth != null && (root.child('isAdmin').val() || (auth.uid === data.parent().child('teacherId').val()))"
        },
        "approverComment": {
            ".write": "auth != null && (root.child('isAdmin').val() || (auth.uid === data.parent().child('teacherId').val()))"
        },
        "rejectionReason": {
           ".write": "auth != null && (root.child('isAdmin').val() || (auth.uid === data.parent().child('teacherId').val()))"
        }
      }
    },
    "feedback": {
      ".read": "root.child('isAdmin').val()",
      "$feedbackId": {
        // Any authenticated user can submit feedback
        ".write": "auth != null && newData.child('userId').val() === auth.uid && !data.exists()"
      }
    },
    "homework": {
       ".read": "auth != null",
       ".write": "root.child('isTeacher').val() || root.child('isAdmin').val()",
       ".indexOn": ["classSection", "assignedBy"]
    },
    "salaries": {
      ".read": "auth != null", // Teacher can read their own, admin can read all
      ".write": "root.child('isAdmin').val()",
      ".indexOn": "teacherId"
    },
    "gallery": {
      ".read": "auth != null",
      ".write": "root.child('isTeacher').val() || root.child('isAdmin').val()"
    },
    "school_settings": {
      ".read": true, // Publicly readable for branding
      ".write": "root.child('isAdmin').val()"
    },
    "exams": {
      ".read": "auth != null",
      ".write": "root.child('isAdmin').val()"
    },
    "marks": {
      // Teachers can read marks for their own students
      ".read": "root.child('isTeacher').val()",
      "$studentId": {
        // Students can read their own marks
        ".read": "auth != null && auth.uid === $studentId",
        // Teachers can write marks for their students
        ".write": "root.child('isTeacher').val()"
      }
    }
  }
}
